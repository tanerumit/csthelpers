% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/estimate_scenario_probabilities.R
\name{estimate_scenario_probabilities}
\alias{estimate_scenario_probabilities}
\title{Calculate Climate-Informed Scenario Weights}
\usage{
estimate_scenario_probabilities(
  ensemble_data,
  scenario_grid,
  pr_col = "prcp",
  ta_col = "tavg",
  group_col = "scenario",
  robust = TRUE,
  normalize = TRUE
)
}
\arguments{
\item{ensemble_data}{A data frame containing GCM ensemble results with
temperature, precipitation, and a grouping column (e.g., `scenario` or
`model`).}

\item{scenario_grid}{A data frame (typically created with
[tidyr::expand_grid()]) containing combinations of temperature and
precipitation change values for which density weights are computed.}

\item{pr_col}{Character string. Name of the precipitation column in
`ensemble_data` and `scenario_grid`. Default is `"prcp"`.}

\item{ta_col}{Character string. Name of the temperature column in
`ensemble_data` and `scenario_grid`. Default is `"tavg"`.}

\item{group_col}{Character string. Column name in `ensemble_data` defining
groups for which separate bivariate distributions will be fitted
(typically `"scenario"` or `"model"`). Default is `"scenario"`.}

\item{robust}{Logical; if `TRUE` (default), use a robust covariance estimate
via [MASS::cov.trob()]. If `FALSE`, use the classical covariance with
[stats::cov()]. Robust estimation requires at least 5 observations per
group; classical estimation requires at least 3.}

\item{normalize}{Logical; if `TRUE` (default), densities for each group are
normalized so they sum to one, creating proper probability weights.}
}
\value{
A data frame identical to `scenario_grid`, with one additional column per
group in `ensemble_data`. Each added column contains the normalized bivariate
density values representing the relative likelihood (weight) of each
stress-test combination under that group's fitted climate distribution.

The returned object includes a `"skipped_groups"` attribute listing any
groups that were excluded due to insufficient data or estimation issues.
}
\description{
Fits a bivariate normal distribution to mean temperature and precipitation
changes from an ensemble of GCM projections, then evaluates normalized
probability densities for a grid of stress-test scenarios.
These densities serve as climate-informed weighting factors that can be used
to probabilistically weight scenario outcomes in stress-testing or
adaptation pathway analyses.
}
\details{
For each group in `ensemble_data`, the function:
\enumerate{
  \item Extracts temperature and precipitation change values.
  \item Estimates the mean vector and covariance matrix (robust or classical).
  \item Checks for singular or degenerate covariance matrices.
  \item Evaluates the bivariate normal density for each point in
        `scenario_grid` using [mvtnorm::dmvnorm()].
  \item Optionally normalizes densities so that their sum equals one.
}

The output is particularly useful when combining climate projections with
scenario-based stress tests â€” for example, when weighting hydrological or
economic model outputs by the relative likelihood of each climate change
condition.

**Robust vs. Classical Estimation:**
Robust covariance estimation (via `MASS::cov.trob()`) is less sensitive to
outliers and is recommended when the ensemble contains potential outliers.
Classical estimation uses standard `stats::cov()` and may be preferable for
small, well-behaved ensembles.
}
\note{
Groups will be skipped with a warning if they have:
\itemize{
  \item Insufficient observations (< 5 for robust, < 3 for classical)
  \item Singular or near-singular covariance matrices
  \item Zero variance in temperature or precipitation
  \item Covariance estimation or density computation errors
}
The returned data frame will not include weight columns for skipped groups.
A message will report the number and names of skipped groups, and they are
also available via `attr(result, "skipped_groups")`.

Column names in the output are derived from group values and sanitized using
[base::make.names()] to ensure valid R identifiers.
}
\examples{
\dontrun{
library(dplyr)
library(tidyr)

# Load GCM ensemble data
gcm_data <- readr::read_csv("Rhine/data/CMIP6/annual_change_scalar_stats_summary_mean.csv") \%>\%
  filter(horizon == "near") \%>\%
  rename(prcp = precip, tavg = temp)

# Create stress-test grid
stress_grid <- expand_grid(
  tavg = seq(0, 6, 1),
  prcp = seq(-30, 30, 10)
)

# Calculate weights with robust estimation
weights <- estimate_scenario_probabilities(
  ensemble_data = gcm_data,
  scenario_grid = stress_grid,
  group_col = "scenario",
  robust = TRUE
)

# Check for skipped groups
attr(weights, "skipped_groups")

# Use weights for scenario analysis
weighted_outcomes <- stress_grid \%>\%
  left_join(model_outputs, by = c("tavg", "prcp")) \%>\%
  mutate(
    weighted_impact = impact * weights$SSP245,
    across(starts_with("SSP"), ~ . * impact, .names = "weighted_{.col}")
  )
}

}
