% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/estimate_scenario_probabilities_kde.R,
%   R/gcm_weighting_functions.R
\name{estimate_scenario_probabilities_kde}
\alias{estimate_scenario_probabilities_kde}
\title{Calculate Climate-Informed Scenario Weights (KDE; auto bandwidth; optional family weighting)}
\usage{
estimate_scenario_probabilities_kde(
  ensemble_data,
  scenario_grid,
  weight_col,
  pr_col = "prcp",
  ta_col = "tavg",
  group_col = "scenario",
  bw = NULL,
  k = c(1.5, 2),
  alpha = 1,
  bw_min = c(0, 0),
  bw_max = c(Inf, Inf),
  min_samples = 5L,
  normalize = TRUE,
  chunk_size = 5000L,
  verbose = TRUE
)

estimate_scenario_probabilities_kde(
  ensemble_data,
  scenario_grid,
  weight_col,
  pr_col = "prcp",
  ta_col = "tavg",
  group_col = "scenario",
  bw = NULL,
  k = c(1.5, 2),
  alpha = 1,
  bw_min = c(0, 0),
  bw_max = c(Inf, Inf),
  min_samples = 5L,
  normalize = TRUE,
  chunk_size = 5000L,
  verbose = TRUE
)
}
\arguments{
\item{ensemble_data}{data.frame containing at least group_col, ta_col, pr_col, and weight_col.}

\item{scenario_grid}{data.frame grid with columns ta_col, pr_col.}

\item{weight_col}{Character. Column in `ensemble_data` containing non-negative weights
(per row) within each group. Weights will be re-normalized to sum to 1 within group.}

\item{pr_col}{Character. Precipitation column name. Default "prcp".}

\item{ta_col}{Character. Temperature column name. Default "tavg".}

\item{group_col}{Character. Group/SSP column name. Default "scenario".}

\item{bw}{Numeric length-2 bandwidth vector or NULL for auto. Default NULL.}

\item{k}{Numeric length-2 grid-step multipliers for auto bw. Default c(1.5, 2.0).}

\item{alpha}{Numeric scalar multiplier on data-driven bandwidth in auto bw. Default 1.0.}

\item{bw_min}{Numeric length-2 minimum bandwidths. Default c(0, 0).}

\item{bw_max}{Numeric length-2 maximum bandwidths. Default c(Inf, Inf).}

\item{min_samples}{Integer. Minimum complete observations per group. Default 5.}

\item{normalize}{Logical. If TRUE, normalize grid weights to sum to 1 within each group. Default TRUE.}

\item{chunk_size}{Integer. Chunk size for grid evaluation. Default 5000.}

\item{verbose}{Logical. If TRUE, prints bandwidth per group. Default TRUE.}

\item{use_family_weights}{Logical. If TRUE, downweight near-duplicates by `family_col`.}

\item{family_col}{Character. Column name giving model family. Default `"model_family"`.}
}
\value{
Data frame identical to `scenario_grid` plus one weight column per group (alphabetically ordered).
Attribute `"skipped_groups"` lists groups skipped due to insufficient data or degeneracy.

data.frame = scenario_grid plus one column per group (alphabetically ordered),
with attribute "skipped_groups".
}
\description{
For each group (e.g., SSP), estimates a smooth 2D kernel density surface over
(temperature change, precipitation change) using Gaussian KDE, evaluates it
on a user-provided stress-test grid, and returns normalized weights.

If `bw = NULL`, bandwidths are chosen automatically per group using a
grid-aware rule:
\deqn{bw = max(k * grid_step, alpha * bw_nrd)}
where `grid_step` is the median spacing in `scenario_grid` for each dimension,
`bw_nrd` is a data-driven bandwidth estimate for each dimension, `k` controls
smoothing relative to grid spacing, and `alpha` scales the data-driven bandwidth.

Optionally, observations can be downweighted by model family (near-duplicate control)
so that each family contributes equal total influence within each group.

For each group (e.g., SSP scenario), evaluates a weighted Gaussian 2D kernel density
estimate (KDE) for temperature and precipitation changes on a stress-test grid.
The observation weights must be pre-computed and passed via `weight_col`.

If `bw=NULL`, bandwidths are auto-selected per group using:
  bw = max(k * grid_step, alpha * bw_nrd)
where grid_step is median grid spacing in `scenario_grid` for each dimension, and
bw_nrd is a data-driven bandwidth estimate.
}
